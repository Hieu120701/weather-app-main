<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather App </title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:wght@400;600;900&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* WOW Background Gradient Animation */
   body {
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(120deg, #fbc2eb 0%, #a6c1ee 100%);
  min-height: 100vh;
  color: #222;
  overflow-x: hidden;
  transition: background 0.6s, color 0.5s;
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: radial-gradient(circle at 70% 20%, #fff7f7 0%, #c3e6ff 60%, transparent 100%),
              radial-gradient(circle at 10% 80%, #eaf6fb 0%, #e3e5fa 60%, transparent 100%);
  opacity: 0.7;
  z-index: 0;
  pointer-events: none;
  animation: bgmove 12s infinite alternate;
}
@keyframes bgmove {
  0% { filter: blur(4px); }
  100% { filter: blur(18px) brightness(1.08); }
}
.divider {
  border-bottom: 2px solid #e1e2e9;
  margin: 36px 0 24px 0;
  opacity: 0.7;
}
.sidebar {
  position: fixed; top: 0; left: 0;
  width: 84px; height: 100vh;
  background: rgba(34,44,70,0.97);
  box-shadow: 8px 0 34px 0 rgba(100,140,255,0.19);
  border-right: 2px solid rgba(255,255,255,0.17);
  z-index: 30;
  display: flex; flex-direction: column; align-items: center;
}
.sidebar-content {
  display: flex; flex-direction: column; gap: 34px;
  margin-top: 54px; align-items: center; width: 100%;
}
.sidebar-item {
  background: none; border: none; outline: none;
  padding: 16px;
  border-radius: 18px;
  font-size: 2.1rem;
  color: #c3dafe;
  cursor: pointer;
  margin-bottom: 8px;
  transition: background 0.3s, color 0.3s, transform 0.35s;
  box-shadow: 0 1px 7px 0 rgba(120,120,255,0.07);
  display: flex; align-items: center; justify-content: center;
  animation: sidebarIdle 6s infinite alternate;
}
@keyframes sidebarIdle {
  0% { transform: scale(1);}
  65% { transform: scale(1.04);}
  100% { transform: scale(1);}
}
.sidebar-item.active, .sidebar-item:hover {
  background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
  color: #4474e4;
  box-shadow: 0 3px 20px rgba(120, 120, 255, 0.15);
  transform: scale(1.10) translateY(-7px);
  animation: sidebarBounce 0.5s;
  animation-iteration-count: 1;
}
@keyframes sidebarBounce {
  0%   { transform: scale(1) translateY(0);}
  40%  { transform: scale(1.22) translateY(-12px);}
  70%  { transform: scale(0.98) translateY(8px);}
  100% { transform: scale(1.10) translateY(-7px);}
}
.main-content {
  margin-left: 104px;
  padding: 54px 5vw 38px 5vw;
  max-width: 1450px;
  min-height: 100vh;
  position: relative;
  z-index: 10;
  animation: fadein 0.9s;
}
@keyframes fadein {
  from{ opacity:0; transform: translateY(50px);}
  to{ opacity:1; transform: translateY(0);}
}
@media (max-width: 900px) {
  .main-content { margin-left: 0; padding: 30px 1vw;}
  .sidebar { width: 60px;}
  .sidebar-item { font-size:1.4rem; padding:9px;}
}
.search {
  display: flex; gap: 16px;
  align-items: center;
  margin-bottom: 35px;
  background: rgba(255,255,255,0.55);
  border-radius: 22px;
  box-shadow: 0 1px 10px 0 #b5b5ee22;
  padding: 14px 28px;
  animation: fadein 1.2s;
}
.search input[type="text"] {
  flex: 1 1 320px;
  min-width: 180px;
  padding: 15px 22px;
  border: none;
  border-radius: 22px;
  font-size: 1.11rem;
  background: #f7fafc;
  color: #222;
  box-shadow: 0 1px 8px rgba(100,100,200,0.07);
  outline: none;
  transition: background 0.25s, color 0.25s;
  font-family: inherit;
}
.search button {
  background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
  border: none;
  border-radius: 50%;
  width: 48px; height: 48px;
  font-size: 1.5rem;
  color: #4474e4;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.search button:hover {
  background: linear-gradient(90deg, #fbc2eb 0%, #a6c1ee 100%);
  color: #232526;
  transform: scale(1.07);
}
#toggle-mode { background: linear-gradient(90deg, #fbc2eb 0%, #a6c1ee 100%); color: #232526;}
.main-cards-row {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 38px; margin-bottom: 40px;
}
#current-weather { min-width:350px; }
.weather-card-header {
  display: flex; flex-direction: column; align-items: center; margin-bottom: 7px;
}
.city { font-size: 2.1rem; font-weight: 700; letter-spacing: 1px;}
.text-sm { font-size: 1rem; color: #7b7b7b; margin-top: 2px;}
.weather-icon-big {
  width: 92px; height: 92px; margin: 10px 0 4px 0;
  filter: drop-shadow(0 2px 8px #a0c2ffaa);
  animation: iconWeatherIdle 3s infinite linear;
}
@keyframes iconWeatherIdle {
  0%   { transform: scale(1) translateY(0);}
  10%  { transform: scale(1.11) translateY(-7px);}
  20%  { transform: scale(1.05) translateY(6px);}
  30%  { transform: scale(1) translateY(0);}
  100% { transform: scale(1) translateY(0);}
}
.temp-display { font-size: 2.8rem; font-weight: 900; margin: 9px 0 2px 0; color: #2196f3; letter-spacing: 1px;}
.desc-display { font-size: 1.1rem; color: #6c63ff; margin-bottom: 10px; font-weight: 600; text-align: center;}
.details { display: flex; gap: 22px; margin-top: 8px; width: 100%; justify-content: center;}
.details .col { display: flex; align-items: center; gap: 7px;}
.icon-small { width: 29px; height: 29px; filter: drop-shadow(0 1px 8px #c0d4fc88);}
.detail-label { font-size: 1rem; color: #6c757d;}
.card-block { display: flex; flex-direction: column; align-items: center; width: 100%;}
.card-block-title { font-weight: 700; font-size: 1.15rem; margin-bottom: 7px;}
.locate-btn {
  background: linear-gradient(90deg, #fbc2eb 0%, #a6c1ee 100%);
  color: #4c566a;
  border-radius: 50%; width: 44px; height: 44px; font-size: 1.25rem;
  border: none; margin-bottom: 7px; margin-top: 3px; cursor: pointer;
  transition: background 0.18s;
  box-shadow: 0 2px 8px #c9e6fc55;
  animation: shine 3.2s infinite alternate;
}
.locate-btn:hover {
  background: linear-gradient(90deg, #8ec5fc 0%, #e0c3fc 100%);
  color: #222;
  transform: scale(1.09);
}
.sun-info { width: 100%; display: flex; flex-direction: column; gap: 13px; align-items: flex-start; margin-bottom: 12px;}
.sun-info > div { display: flex; align-items: center; gap: 7px; font-size: 1.09rem;}
.font-bold { font-weight: 700;}
.icon-sunrise, .icon-sunset, .icon-clock { width: 24px; height: 24px; vertical-align: middle; margin-right: 2px;}
#sunChart { margin-top: 10px; border-radius: 13px; background: rgba(240,240,255,0.42); box-shadow: 0 2px 10px 0 #b5b5ee22;}
.hourly-section {
  background: rgba(255,255,255,0.88);
  border-radius: 22px;
  padding: 26px 22px 22px 22px;
  margin-bottom: 20px;
  box-shadow: 0 2px 18px 0 #b3b3e322;
  transition: background 0.35s;
  position: relative;
  overflow: hidden;
  animation: fadein 1.5s;
}
.section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 12px; color: #4b5c6b;}
.tab-menu { margin-bottom: 14px; display: flex; flex-wrap: wrap; gap: 13px;}
.tab-btn { padding: 9px 19px; border-radius: 18px; border: none; background: #e0eafc; color: #546e7a; font-size: 1.09rem; font-weight: 500; cursor: pointer; transition: background 0.2s, color 0.2s;}
.tab-btn.active, .tab-btn:hover { background: linear-gradient(90deg, #fbc2eb 0%, #a6c1ee 100%); color: #232526; }
.table-responsive {
  width: 100%;
  overflow-x: auto;
  min-width: 700px;
  max-width: 100vw;
}
#hourlyChart { border-radius: 13px; background: rgba(245,250,255,0.60); margin-bottom: 12px; box-shadow: 0 1px 8px 0 #b5b5ee22;}
#daily-forecast { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;}
.daily-card {
  background: linear-gradient(130deg, #f9f9f9 60%, #e0eafc 100%);
  border-radius: 15px;
  padding: 12px 16px;
  min-width: 80px;
  text-align: center;
  box-shadow: 0 1px 11px 0 #c1c7e822;
  display: flex; flex-direction: column; align-items: center;
  font-size: 1.03rem;
  animation: fadein 2.1s;
}
.daily-icon { width: 35px; height: 35px; margin: 7px 0;}
.weather-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 18px; margin-top: 34px; justify-content: start;}
.weather-detail-title { font-size: 1.2rem; font-weight: 700; color: #7a4cff; letter-spacing: 0.5px;}
.weather-detail-time { font-size: 1rem; color: #b0b0b0; font-weight: 500;}
.weather-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
  gap: 32px;
  margin-bottom: 32px;
}
.card.glass { background: rgba(255,255,255,0.76); border-radius: 19px; padding: 18px 11px 15px 13px; box-shadow: 0 1px 7px 0 #b3b3e322; display: flex; flex-direction: column; align-items: center; min-height: 120px; transition: background 0.3s;}
.card-title { font-size: 1.05rem; font-weight: 700; color: #4b5c6b;}
.card-main { font-size: 2rem; font-weight: 700; margin: 7px 0; color: #2196f3; display: flex; align-items: center; gap: 8px;}
.card-desc { color: #7b7b7b; font-size: 1rem; margin-bottom: 8px; text-align: center;}
.wind-time-label { font-size: 0.97rem; color: #7a4cff; font-weight: 500; margin-left: 7px;}
canvas[id$='-spark'] { margin-top: 4px; border-radius: 8px; background: rgba(230,240,255,0.32); box-shadow: 0 1px 8px 0 #b5b5ee22;}
#weather-map-container {
  background: rgba(255,255,255,0.82);
  border-radius: 21px;
  box-shadow: 0 2px 18px 0 #b3b3e322;
  padding: 24px 18px;
  margin-bottom: 24px; margin-top: 24px;
}
#map { border-radius: 16px; box-shadow: 0 1px 7px 0 #b5b5ee22; margin-bottom: 12px;}
#weather-alert { color: #e53e3e; font-weight: 600; background: #fff5f5; border-radius: 8px; padding: 8px 14px; box-shadow: 0 1px 7px 0 #ffbaba12;}
.mt-2 { margin-top: 12px !important; }
.mt-8 { margin-top: 44px !important; }
.mb-4 { margin-bottom: 16px !important; }
.text-center { text-align: center !important; }
.text-xs { font-size: 0.92rem !important; }
footer { margin-top: 40px; width: 100%; }
footer p { color: #888; text-align: center; font-size: 1.03rem; letter-spacing: 1px;}
@media (max-width: 600px) {
  .main-cards-row { grid-template-columns: 1fr; gap: 20px;}
  .weather-grid { grid-template-columns: 1fr 1fr; gap: 13px;}
  .main-content { padding: 16px 1vw;}
  .sidebar { width: 56px; }
  .sidebar-content { gap: 18px;}
  .sidebar-item { font-size: 1rem; padding: 6px;}
  .table-responsive { min-width: 350px; }
}
body.dark-mode {
  background: linear-gradient(120deg, #232526 0%, #414345 100%);
  color: #e1e6f1;
}
body.dark-mode .hourly-section,
body.dark-mode .main-card,
body.dark-mode .glass,
body.dark-mode .search,
body.dark-mode .sidebar,
body.dark-mode .card,
body.dark-mode .main-content,
body.dark-mode .divider,
body.dark-mode .tab-btn,
body.dark-mode .weather-grid,
body.dark-mode .daily-card,
body.dark-mode .table-responsive,
body.dark-mode #weather-map-container
{
  background: rgba(30,36,55,0.89) !important;
  color: #e1e6f1 !important;
  box-shadow: 0 4px 24px #151b29cc, 0 1px 9px #0002;
}

body.dark-mode .tab-btn.active,
body.dark-mode .tab-btn:hover {
  background: linear-gradient(90deg, #232526 0%, #414345 100%) !important;
  color: #fff !important;
}

body.dark-mode .sidebar {
  background: rgba(10,15,28,0.98) !important;
  border-right: 2px solid #2e2e3a !important;
}

body.light-mode {
  background: linear-gradient(120deg, #fbc2eb 0%, #a6c1ee 100%);
  color: #222;
}

/* Nếu thích, có thể thêm các màu sáng cho light-mode, nhưng mặc định đã là sáng */

  </style>
</head>
<body>
  <aside class="sidebar" aria-label="Main navigation">
    <nav class="sidebar-content">
      <button class="sidebar-item active" title="Trang chủ" id="home-icon">
        <i class="fa-solid fa-house sidebar-icon"></i>
      </button>
      <button class="sidebar-item" title="Bản đồ thời tiết" id="weather-map-icon">
        <i class="fa-solid fa-bullseye sidebar-icon"></i>
      </button>
      <button class="sidebar-item" title="Thời gian" id="time-icon">
        <i class="fa-regular fa-clock sidebar-icon"></i>
      </button>
      <button class="sidebar-item" title="Lịch tháng" id="calendar-icon">
        <i class="fa-regular fa-calendar sidebar-icon"></i>
      </button>
      <button class="sidebar-item" title="Cảnh báo thời tiết" id="cloud-icon">
        <i class="fa-solid fa-cloud sidebar-icon"></i>
      </button>
 </nav>
  </aside>
  <section class="weather-hero-row">
  <!-- Block 1: Weather -->
  <div class="weather-hero-block">
    <!-- Nội dung thời tiết hiện tại -->
  </div>
  <!-- Block 2: Windy Map -->
  <div class="weather-hero-block center">
    <!-- Nội dung Windy map -->
  </div>
  <!-- Block 3: Sun Info -->
  <div class="weather-hero-block">
    <!-- Nội dung mặt trời -->
  </div>
</section>
  <main class="main-content">
    <!-- Search Bar -->
    <form class="search" autocomplete="off" onsubmit="event.preventDefault();">
      <input id="search-input" type="text" placeholder="都市名を入力してください" aria-label="都市名を入力してください" />
      <button id="search-btn" type="button" aria-label="Tìm kiếm">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
      <button id="toggle-mode" type="button" title="Chuyển chế độ sáng/tối" aria-label="Chuyển chế độ sáng/tối">
        <i class="fa-regular fa-moon"></i>
      </button>
    </form>
    <section class="main-cards-row">
      <section id="current-weather" class="main-card glass" aria-label="Thời tiết hiện tại">
        <div class="weather-card-header">
          <h1 class="city" id="location-name">都市名</h1>
          <p class="text-sm" id="weather-time">時刻</p>
        </div>
        <img src="images/clouds.png" class="weather-icon-big" id="weather-img" alt="天気アイコン">
        <div class="temp-display" id="temperature">--℃</div>
        <div class="desc-display" id="description">天気説明</div>
        <div class="details">
          <div class="col">
            <img src="images/humidity.png" class="icon-small" alt="湿度">
            <div>
              <span class="humidity" id="humidity">--%</span>
              <div class="detail-label">湿度</div>
            </div>
          </div>
          <div class="col">
            <img src="images/wind.png" class="icon-small" alt="風速">
            <div>
              <span class="wind" id="wind">--km/h</span>
              <div class="detail-label">風速</div>
            </div>
          </div>
        </div>
      </section>
      <section class="main-card glass" aria-label="Bản đồ gió">
        <div class="card-block">
          <span class="card-block-title">現在地で検索</span>
          <button id="locate-btn" class="locate-btn" aria-label="Định vị">
            <i class="fa-solid fa-location-crosshairs"></i>
          </button>
          <a href="https://www.windy.com/?35.6895,139.6917,5" target="_blank" title="Xem thời tiết động trên Windy" class="windy-link">
            <iframe
              width="100%"
              height="210"
              src="https://embed.windy.com/embed2.html?lat=36.2048&lon=138.2529&detailLat=36.2048&detailLon=138.2529&width=600&height=260&zoom=5&level=surface&overlay=wind&product=ecmwf&menu=&message=true&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1"
              frameborder="0"
              style="border:0; border-radius:18px; display:block; width:100%; min-width:180px; max-width:100%; margin-top:16px;"
              allowfullscreen
              aria-label="Bản đồ Windy">
            </iframe>
          </a>
        </div>
      </section>
      <section class="main-card glass" id="sun-info" aria-label="Thông tin mặt trời">
        <div class="sun-info">
          <div>
            <img src="images/sunrise.png" class="icon-sunrise" alt="日の出"> <span>日の出:</span> <span class="font-bold" id="sunrise">--:--</span>
          </div>
          <div>
            <img src="images/sunset.png" class="icon-sunset" alt="日の入り"> <span>日の入り:</span> <span class="font-bold" id="sunset">--:--</span>
          </div>
          <div>
            <img src="images/clock.png" class="icon-clock" alt="長さ"> <span>長さ:</span> <span class="font-bold" id="day-length">--時間</span>
          </div>
          <canvas id="sunChart" width="340" height="130"></canvas>
        </div>
      </section>
    </section>
    <div id="error-message" class="mb-4" role="alert"></div>
    <div id="weather-notice" aria-live="polite"></div>
    <section class="hourly-section mt-2">
      <header>
        <h2 class="section-title">1時間ごとの予報</h2>
        <nav class="tab-menu" aria-label="Dự báo theo giờ">
          <button class="tab-btn active" data-type="rain">降水量</button>
          <button class="tab-btn" data-type="wind">風</button>
          <button class="tab-btn" data-type="humidity">湿度</button>
          <button class="tab-btn" data-type="cloud">雲量</button>
          <button class="tab-btn" data-type="pressure">気圧</button>
          <button class="tab-btn" data-type="visibility">視界</button>
          <button class="tab-btn" data-type="feelslike">体感温度</button>
        </nav>
      </header>
      <div id="hourly-forecast">
        <canvas id="hourlyChart" width="600" height="230"></canvas>
      </div>
      <div style="margin-top: 32px;">
        <div id="daily-forecast"></div>
      </div>
    </section>
    <section>
      <header class="weather-detail-header">
        <span class="weather-detail-title">天気の詳細情報</span>
        <span class="weather-detail-time" id="weather-detail-time"></span>
      </header>
      <div class="weather-grid">
        <div class="card glass">
          <div class="card-title">気温</div>
          <div class="card-main">
            <div class="card-value" id="temp-value">--°</div>
          </div>
          <div class="card-desc" id="temp-desc"></div>
          <canvas id="temp-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">体感温度</div>
          <div class="card-main">
            <div class="card-value" id="feels-value">--°</div>
          </div>
          <div class="card-desc" id="feels-desc"></div>
          <canvas id="feels-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">雲量</div>
          <div class="card-main">
            <div class="card-value" id="clouds-value">--</div>
          </div>
          <div class="card-desc" id="clouds-desc"></div>
          <canvas id="clouds-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">降水量</div>
          <div class="card-main">
            <div class="card-value" id="rain-value">--</div>
          </div>
          <div class="card-desc" id="rain-desc"></div>
          <canvas id="rain-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">風</div>
          <div class="card-main">
            <div class="card-value" id="wind-value">--</div>
            <span class="wind-time-label" id="wind-time"></span>
          </div>
          <div class="card-desc" id="wind-desc"></div>
          <canvas id="wind-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">湿度</div>
          <div class="card-main">
            <div class="card-value" id="humidity-value">--%</div>
          </div>
          <div class="card-desc" id="humidity-desc"></div>
          <canvas id="humidity-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">視界</div>
          <div class="card-main">
            <div class="card-value" id="visibility-value">--</div>
          </div>
          <div class="card-desc" id="visibility-desc"></div>
          <canvas id="visibility-spark" width="120" height="32"></canvas>
        </div>
        <div class="card glass">
          <div class="card-title">気圧</div>
          <div class="card-main">
            <div class="card-value" id="pressure-value">--</div>
          </div>
          <div class="card-desc" id="pressure-desc"></div>
          <canvas id="pressure-spark" width="120" height="32"></canvas>
        </div>
      </div>
    </section>
    <footer>
      <p class="mt-8 text-center text-xs" style="opacity:.7">Made by VINMO.DEV <span style="color:#ff4181; font-size:1.15em;">♥</span></p>
    </footer>
    <section id="weather-map-container" style="display:none; margin-top: 16px;">
      <div id="map" style="height:400px;"></div>
      <div id="weather-alert" style="color:red; margin-top:8px;"></div>
    </section>
  </main>
  <script>
    // --- Sun chart logic ---
    function timeToHour(timeStr) {
      if (!timeStr || timeStr === '--:--') return 0;
      const [h, m] = timeStr.split(":").map(Number);
      return h + m / 60;
    }
    function hourToTimeLabel(hour) {
      const h = Math.floor(hour);
      const m = Math.round((hour - h) * 60);
      return `${h}:${m.toString().padStart(2, '0')}`;
    }
    function drawSunChart() {
      const sunrise = document.getElementById('sunrise').textContent.trim();
      const sunset = document.getElementById('sunset').textContent.trim();
      if (window.sunChartInstance) window.sunChartInstance.destroy();
      const ctx = document.getElementById('sunChart').getContext('2d');
      const dataArr = [timeToHour(sunrise), timeToHour(sunset)];
      window.sunChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['日の出', '日の入り'],
          datasets: [{
            label: '時刻',
            data: dataArr,
            backgroundColor: ['#FFD700', '#FF8C00']
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return hourToTimeLabel(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 24,
              title: { display: true, text: '時' },
              ticks: {
                callback: function(value) {
                  return hourToTimeLabel(value);
                }
              }
            }
          }
        }
      });
    }
    window.addEventListener('DOMContentLoaded', drawSunChart);

    // --- Weather Logic ---
    const apikey = "70a0b2cb36a5ef013414269041b73822";
    const apiUrl = "https://api.openweathermap.org/data/2.5/weather?units=metric&q=";
    const forecastApiUrl = "https://api.openweathermap.org/data/2.5/forecast?units=metric&q=";

    const searchInput = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-btn");
    const weatherImg = document.getElementById("weather-img");

    let currentHourlyType = "rain";
    let lastForecastData = null;
    let hourlyChart = null;

    const iconMap = {
      "Clouds": "clouds.png",
      "Rain": "rain.png",
      "Clear": "clear.png",
      "Mist": "mist.png",
      "Drizzle": "drizzle.png",
      "Snow": "snow.png",
      "Thunderstorm": "thunder.png",
      "Night": "night.png",
      "Hurricane": "hurricane.png",
      "Taifuu": "taifuu.png"
    };

    function getIconUrl(main, icon = "") {
      if (icon && icon.endsWith('n')) return "images/night.png";
      if (main === "Hurricane") return "images/hurricane.png";
      if (main === "Taifuu") return "images/taifuu.png";
      return "images/" + (iconMap[main] || "clouds.png");
    }

    function renderHourlyChart(forecastData, type = "rain") {
      if (!forecastData) return;
      const labels = forecastData.list.slice(0, 8).map(f =>
        `${new Date(f.dt * 1000).getHours()}:00`
      );
      let data = [];
      let label = '';
      let color = '';
      switch (type) {
        case 'rain':
          data = forecastData.list.slice(0, 8).map(f => (f.rain && f.rain["3h"] ? f.rain["3h"] : 0));
          label = '降水量 (mm)';
          color = 'blue';
          break;
        case 'wind':
          data = forecastData.list.slice(0, 8).map(f => f.wind.speed);
          label = '風速 (m/s)';
          color = 'green';
          break;
        case 'humidity':
          data = forecastData.list.slice(0, 8).map(f => f.main.humidity);
          label = '湿度 (%)';
          color = 'orange';
          break;
        case 'cloud':
          data = forecastData.list.slice(0, 8).map(f => f.clouds.all);
          label = '雲量 (%)';
          color = 'gray';
          break;
        case 'pressure':
          data = forecastData.list.slice(0, 8).map(f => f.main.pressure);
          label = '気圧 (hPa)';
          color = 'purple';
          break;
        case 'feelslike':
          data = forecastData.list.slice(0, 8).map(f => f.main.feels_like);
          label = '体感温度 (°C)';
          color = 'red';
          break;
        case 'visibility':
          data = forecastData.list.slice(0, 8).map(f => f.visibility ? (f.visibility/1000).toFixed(1) : 0);
          label = '視界 (km)';
          color = 'brown';
          break;
      }
      
      const ctx = document.getElementById('hourlyChart').getContext('2d');
      if (hourlyChart) {
        hourlyChart.destroy();
      }
      hourlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            borderColor: color,
            backgroundColor: color,
            fill: false,
            tension: 0.3,
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentHourlyType = this.getAttribute('data-type');
        if (lastForecastData) renderHourlyChart(lastForecastData, currentHourlyType);
      });
    });

    async function checkWeather(city = "Tokyo") {
      try {
        const response = await fetch(apiUrl + encodeURIComponent(city) + '&appid=' + apikey + '&lang=ja');
        const forecastResponse = await fetch(forecastApiUrl + encodeURIComponent(city) + '&appid=' + apikey + '&lang=ja');

        if (response.status == 404 || forecastResponse.status == 404) {
          document.getElementById("error-message").textContent = "都市名が正しくありません";
          document.getElementById("current-weather").style.display = "none";
          document.getElementById("hourly-forecast").style.display = "none";
          document.getElementById("sun-info").style.display = "none";
          document.getElementById("daily-forecast").style.display = "none";
          document.getElementById("weather-notice").style.display = "none";
          return;
        } else {
          document.getElementById("error-message").textContent = "";
          document.getElementById("current-weather").style.display = "";
          document.getElementById("hourly-forecast").style.display = "";
          document.getElementById("sun-info").style.display = "";
          document.getElementById("daily-forecast").style.display = "";
          document.getElementById("weather-notice").style.display = "flex";
        }

        const data = await response.json();
        const forecastData = await forecastResponse.json();

        document.getElementById("location-name").innerText = data.name;
        document.getElementById("temperature").innerText = Math.round(data.main.temp) + "°C";
        document.getElementById("humidity").innerText = data.main.humidity + "%";
        document.getElementById("wind").innerText = data.wind.speed + "km/h";
        document.getElementById("description").innerText = data.weather[0].description;
        const weatherTimeStr = new Date(data.dt * 1000).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Tokyo' });
        document.getElementById("weather-time").innerText = weatherTimeStr;

        weatherImg.src = getIconUrl(data.weather[0].main, data.weather[0].icon);

        const sunriseTime = new Date(data.sys.sunrise * 1000).toLocaleTimeString("ja-JP", { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' });
        const sunsetTime = new Date(data.sys.sunset * 1000).toLocaleTimeString("ja-JP", { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' });
        document.getElementById('sunrise').textContent = sunriseTime;
        document.getElementById('sunset').textContent = sunsetTime;
        drawSunChart();

        const duration = (data.sys.sunset - data.sys.sunrise) / 3600;
        document.getElementById("day-length").textContent = `${Math.floor(duration)}時間${Math.round((duration % 1) * 60)}分`;

        const daily = {};
        forecastData.list.forEach(f => {
          const day = new Date(f.dt * 1000).toLocaleDateString("ja-JP", { weekday: 'short' });
          if (!daily[day]) daily[day] = [];
          daily[day].push(f);
        });
        document.getElementById("daily-forecast").innerHTML = Object.entries(daily).slice(0, 7).map(([day, list]) => {
          let mid = list.find(l => new Date(l.dt * 1000).getHours() === 12)
                  || list.find(l => l.weather[0].main === "Clear")
                  || list.find(l => l.weather[0].icon && l.weather[0].icon.startsWith("01"))
                  || list[0];
          const temps = list.map(l => l.main.temp);
          const max = Math.round(Math.max(...temps));
          const min = Math.round(Math.min(...temps));
          const icon = getIconUrl(mid.weather[0].main, mid.weather[0].icon);
          const desc = mid.weather[0].description;
          return `<div class="daily-card">
            <div>${day}</div>
            <img src="${icon}" class="daily-icon" alt="">
            <div style="font-size:13px;">${desc}</div>
            <div>${max}° / ${min}°</div>
          </div>`;
        }).join('');

        document.getElementById('temp-value').textContent = Math.round(data.main.temp) + "°";
        document.getElementById('feels-value').textContent = Math.round(data.main.feels_like) + "°";
        document.getElementById('clouds-value').textContent = data.clouds.all + "%";
        document.getElementById('rain-value').textContent = (data.rain && data.rain["1h"] ? data.rain["1h"] : 0) + " mm";
        document.getElementById('wind-value').textContent = data.wind.speed + " m/s";
        document.getElementById('humidity-value').textContent = data.main.humidity + "%";
        document.getElementById('visibility-value').textContent = (data.visibility/1000).toFixed(1) + " km";
        document.getElementById('pressure-value').textContent = data.main.pressure + " hPa";

        const windTimestamp = data.dt;
        const windTimeStr = new Date(windTimestamp * 1000).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' });
        document.getElementById("wind-time").textContent = windTimeStr;

        const temps = forecastData.list.slice(0, 8).map(f => f.main.temp);
        drawSparkline("temp-spark", temps, "#4fd1c5");

        const feels = forecastData.list.slice(0, 8).map(f => f.main.feels_like);
        drawSparkline("feels-spark", feels, "#f56565");

        const clouds = forecastData.list.slice(0, 8).map(f => f.clouds.all);
        drawSparkline("clouds-spark", clouds, "#a0aec0");

        const rain = forecastData.list.slice(0, 8).map(f => (f.rain && f.rain["3h"] ? f.rain["3h"] : 0));
        drawSparkline("rain-spark", rain, "#4299e1");

        const wind = forecastData.list.slice(0, 8).map(f => f.wind.speed);
        drawSparkline("wind-spark", wind, "#48bb78");

        const humidity = forecastData.list.slice(0, 8).map(f => f.main.humidity);
        drawSparkline("humidity-spark", humidity, "#ecc94b");

        const visibility = forecastData.list.slice(0, 8).map(f => f.visibility ? (f.visibility/1000).toFixed(1) : 0);
        drawSparkline("visibility-spark", visibility, "#805ad5");

        const pressure = forecastData.list.slice(0, 8).map(f => f.main.pressure);
        drawSparkline("pressure-spark", pressure, "#38b2ac");
        lastForecastData = forecastData;
        renderHourlyChart(forecastData, currentHourlyType);

      } catch (e) {
        document.getElementById("error-message").innerText = "";
      }
    }

    searchBtn.addEventListener("click", () => {
      checkWeather(searchInput.value);
    });
    searchInput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        checkWeather(searchInput.value);
      }
    });

    document.getElementById("toggle-mode").addEventListener("click", () => {
      const body = document.body;
      if (body.classList.contains("dark-mode")) {
        body.classList.remove("dark-mode");
        body.classList.add("light-mode");
      } else if (body.classList.contains("light-mode")) {
        body.classList.remove("light-mode");
        body.classList.add("dark-mode");
      } else {
        body.classList.add("dark-mode");
      }
    });

    document.getElementById("locate-btn").addEventListener("click", function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apikey}&units=metric&lang=ja`)
            .then(res => res.json())
            .then(data => {
              if (data && data.name) {
                checkWeather(data.name);
              } else {
                document.getElementById("error-message").textContent = "位置情報から都市名を取得できません";
              }
            })
            .catch(() => {
              document.getElementById("error-message").textContent = "位置情報の取得に失敗しました";
            });

        }, function() {
          document.getElementById("error-message").textContent = "位置情報の取得に失敗しました";
        });
      } else {
        document.getElementById("error-message").textContent = "このブラウザは位置情報取得に対応していません";
      }
    });

    checkWeather("Tokyo");

    function drawSparkline(canvasId, data, color = "#4fd1c5") {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map((_, i) => i + 1),
          datasets: [{
            data: data,
            borderColor: color,
            backgroundColor: "rgba(0,0,0,0)",
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4,
          }]
        },
        options: {
          responsive: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { display: false }
          }
        }
      });
    }

    function updateWeatherDetailTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' });
      document.getElementById('weather-detail-time').textContent = timeStr;
    }
    updateWeatherDetailTime();
    setInterval(updateWeatherDetailTime, 60000);

    // Sidebar navigation
    document.getElementById('home-icon').onclick = function() {
      window.location.href = 'index.html';
    };
    document.getElementById('weather-map-icon').onclick = function() {
      window.location.href = 'maps.html';
    };
    document.getElementById('time-icon').onclick = function() {
      window.location.href = 'time.html';
    };
    document.getElementById('calendar-icon').onclick = function() {
      window.location.href = 'monthly-forecast.html';
    };
    document.getElementById('cloud-icon').onclick = function() {
      window.location.href = 'warning.html';
    };

    function showWeatherMap() {
      if (!window.weatherMap) {
        window.weatherMap = L.map('map').setView([21.0285, 105.8542], 6); // Hà Nội mặc định
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap'
        }).addTo(window.weatherMap);

        L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${apikey}`).addTo(window.weatherMap);
      }
    }
    
  </script>
</body>
</html>